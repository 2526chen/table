!function(t,a){"function"==typeof define&&define.amd?define(["$","handlebars","paging","query","dialog"],a):t.Table=a($,Handlebars,Paging,Query,Dialog)}(this,function(t,a,e,i,r){function n(a,e,i,r,n,s,l){this.search=n,this.table=a,this.page=i,this.filterCon=l,this.temp=e,this.template=null,this.pageData=null,this.ajaxurl=a.attr("ajaxurl"),this.ajaxDeleteItemUrl=a.attr("data-ajax-deleteitem-url"),this.currentPage=1,this._total=0,this.pageSize=i.attr("pagesize")||10,this.callback=s,this.param=t.extend(r,{})}return a.registerHelper("equalsten",function(t,a){return t%10==0&&0!=t?a.fn(this):a.inverse(this)}),a.registerHelper("equals",function(t,a,e){return t==a?e.fn(this):e.inverse(this)}),a.registerHelper("indexOf",function(t,a,e){for(var i=!1,r=0,n=a.length;n>r;r++)a[r]==t&&(i=!0);return i?e.fn(this):e.inverse(this)}),a.registerHelper("formatMoney",function(a){var e=a.split("-");return e.length>1?formatAmount.doFormat(t.trim(e[0]))+" - "+formatAmount.doFormat(t.trim(e[1])):formatAmount.doFormat(t.trim(e[0]))}),a.registerHelper("addOne",function(t){return parseInt(t)+1||1}),n.prototype={init:function(t){var e=this.temp.html();this.template=a.compile(e),this.settings=t||{type:"get"},this.search&&(this.param=this.getParam(this.search.closest(".form")),this.bindSearch()),this.bind(),this.event()},event:function(){var a=this;t(this.table).bind("reload",function(){a.gosearch()}),this.table.delegate("tr","click",function(){t(this).attr("href")&&!t(this).hasClass("dialog")&&(location.href=t(this).attr("href"))}),this.table.delegate(".js-ajax","click",function(){if(t(this).attr("href")){var e=t(this).attr("href"),i=t(this).attr("js-ajax-param")||{};if(t(this).attr("confirm-msg"))t.confirm(t(this).attr("confirm-msg"),[{yes:"确定"},{no:"取消"}],function(r){var n=this;if("yes"==r){var s={url:e,type:"POST",data:i,dataType:"json"};t.ajax(s).done(function(e){e.status?(n.hide(),a.gosearch(a.currentPage)):t.alert(e.msg)})}else n.hide()});else{var r={url:e,type:"POST",data:i,dataType:"json"};t.ajax(r).done(function(e){e.status?a.gosearch(a.currentPage):t.alert(e.msg)})}}return!1}),t(this.table).on("click",".js-delegate-delete",function(e){var i=t(this).attr("href"),r=t(this).attr("js-ajax-param")||{},n=t(this);return t.confirm("是否确认删除该记录？",[{yes:"确定"},{no:"取消"}],function(s){var l=this;if("yes"==s){var o={url:i,type:"POST",data:r,dataType:"json"};t.ajax(o).done(function(i){i.status?(t(e.target).closest("tr").remove(),l.hide(),setTimeout(function(){0==n.closest("tr").siblings("tr").size()&&a.currentPage>1?(a.currentPage--,a.gosearch(a.currentPage)):a.gosearch(a.currentPage)},500)):t.alert(i.msg)})}else l.hide()}),!1})},bindSearch:function(){var t=this;this.search.click(function(){t.gosearch()})},gosearch:function(a){var e=this;e.currentPage=a||1,e.search&&(e.param=t.extend(e.param,e.getParam(e.search.closest(".form")))),e.param=t.extend(e.param,e.getParam(t(e.filterCon))),e.bind()},getParam:function(t){return i.getForm(t)},bind:function(){var a=this;if(this.param=t.extend(this.param,{page:this.currentPage,page_size:this.pageSize}),a.table.css("position","relative"),0==a.table.find(".loadingdata").size()){var e=a.table.height()/2-32;e=0>e?32:e,e=30;var i=a.table.width()/2-32;a.table.find("tbody,.tbody").html(""),a.table.nextAll(".sg-pager").find(".nodata").html(""),a.page.hide(),a.table.append('<div class="loadingdata" style="position:absolute;left:'+i+"px;top:"+e+'px;"/>')}a.ajaxData(a.ajaxurl,a.param).done(function(e){if(a.page.show(),a.loading&&a.loading.remove(),t(".loadingdata").remove(),e.status){var i=e.data,r=a.template(i);a.table.html(r),e.data&&(a._total=e.data.count.total||0),a.initPager(),a.callback?a.callback.call(a,e.data,a.table):null}else t.alert(e.msg),a.table.html(e.msg)})},initPager:function(){var t=this,a=t.page;a.data("pagesize")?t.pageSize=a.data("pagesize"):a.data("pagesize",t.pageSize),a.attr("pagesize",t.pageSize),a.parent().prevAll().remove(),0==t._total?(t.table.html('<p class="pdl10 nodata">没有符合条件的数据!</p>'),a.hide()):a.show(),this.pageData?this.pageData.render({count:t._total,pagesize:t.pageSize,current:this.currentPage}):(this.pageData=new e,this.pageData.init({target:this.page,pagesize:t.pageSize,count:t._total,callback:function(a){t.currentPage=a,t.bind()}}))},ajaxData:function(a,e){e=t.extend({},e);var i=t.ajax({type:this.settings.type,url:a,data:e,dataType:"json"});return i}},n});